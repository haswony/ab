<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="/">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Primary Meta Tags -->
  <title>بلدروز - منصة بيع وشراء المنتجات في العراق</title>
  <meta name="title" content="بلدروز - منصة بيع وشراء المنتجات في العراق">
  <meta name="description" content="منصة بلدروز للبيع والشراء في العراق. ابحث عن المنتجات المستعملة والجديدة، السيارات، العقارات، والمزيد. سهلة الاستخدام وآمنة.">
  <meta name="keywords" content="بيع, شراء, منتجات, سيارات, عقارات, إلكترونيات, أثاث, وظائف, خدمات, العراق, بلدروز">
  <meta name="author" content="بلدروز">
  <meta name="robots" content="index, follow">
  <meta name="language" content="Arabic">
  <meta name="revisit-after" content="1 days">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://baladruz.com/">
  <meta property="og:title" content="بلدروز - منصة بيع وشراء المنتجات في العراق">
  <meta property="og:description" content="منصة بلدروز للبيع والشراء في العراق. ابحث عن المنتجات المستعملة والجديدة، السيارات، العقارات، والمزيد.">
  <meta property="og:image" content="https://baladruz.com/assets/icon/baladruz.png">
  <meta property="og:site_name" content="بلدروز">
  <meta property="og:locale" content="ar_IQ">

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://baladruz.com/">
  <meta property="twitter:title" content="بلدروز - منصة بيع وشراء المنتجات في العراق">
  <meta property="twitter:description" content="منصة بلدروز للبيع والشراء في العراق. ابحث عن المنتجات المستعملة والجديدة، السيارات، العقارات، والمزيد.">
  <meta property="twitter:image" content="https://baladruz.com/assets/icon/baladruz.png">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="بلدروز">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>baladroz</title>
  <link rel="manifest" href="manifest.json">

  <script>
    // Function to update meta tags dynamically for social media sharing
    function updateMetaTags(productData) {
      // Update title
      document.title = productData.title + ' - بلدروز';
      
      // Update or create meta tags
      function updateOrCreateMetaTag(property, content, isProperty = false) {
        const selector = isProperty ? `meta[property="${property}"]` : `meta[name="${property}"]`;
        let metaTag = document.querySelector(selector);
        
        if (metaTag) {
          metaTag.setAttribute('content', content);
        } else {
          metaTag = document.createElement('meta');
          if (isProperty) {
            metaTag.setAttribute('property', property);
          } else {
            metaTag.setAttribute('name', property);
          }
          metaTag.setAttribute('content', content);
          document.head.appendChild(metaTag);
        }
      }

      // Update basic meta tags
      updateOrCreateMetaTag('title', productData.title + ' - بلدروز');
      updateOrCreateMetaTag('description', productData.description || 'منتج معروض للبيع في بلدروز');
      
      // Update Open Graph tags
      updateOrCreateMetaTag('og:title', productData.title + ' - بلدروز', true);
      updateOrCreateMetaTag('og:description', productData.description || 'منتج معروض للبيع في بلدروز', true);
      updateOrCreateMetaTag('og:image', productData.imageUrl || 'https://baladruz.com/assets/icon/baladruz.png', true);
      updateOrCreateMetaTag('og:url', window.location.href, true);
      updateOrCreateMetaTag('og:type', 'product', true);
      
      // Update Twitter meta tags
      updateOrCreateMetaTag('twitter:title', productData.title + ' - بلدروز', true);
      updateOrCreateMetaTag('twitter:description', productData.description || 'منتج معروض للبيع في بلدروز', true);
      updateOrCreateMetaTag('twitter:image', productData.imageUrl || 'https://baladruz.com/assets/icon/baladruz.png', true);
      updateOrCreateMetaTag('twitter:card', 'summary_large_image', true);
      
      // Add product-specific meta tags
      if (productData.price) {
        updateOrCreateMetaTag('product:price:amount', productData.price.toString(), true);
        updateOrCreateMetaTag('product:price:currency', 'IQD', true);
      }
      
      if (productData.category) {
        updateOrCreateMetaTag('product:category', productData.category, true);
      }
      
      if (productData.condition) {
        updateOrCreateMetaTag('product:condition', productData.condition, true);
      }
      
      if (productData.location) {
        updateOrCreateMetaTag('product:location', productData.location, true);
      }
    }

    // Function to reset meta tags to default
    function resetMetaTags() {
      document.title = 'بلدروز - منصة بيع وشراء المنتجات في العراق';
      
      // Reset to default values
      const defaultData = {
        title: 'بلدروز - منصة بيع وشراء المنتجات في العراق',
        description: 'منصة بلدروز للبيع والشراء في العراق. ابحث عن المنتجات المستعملة والجديدة، السيارات، العقارات، والمزيد.',
        imageUrl: 'https://baladruz.com/assets/icon/baladruz.png'
      };
      
      updateMetaTags(defaultData);
    }

    // Function to detect and handle product pages
    function handleRouteChange() {
      // Check if we're on a product page
      const currentHash = window.location.hash;
      const productMatch = currentHash.match(/#\/product\/(.+)/);
      
      if (productMatch) {
        const productId = productMatch[1];
        console.log('Product page detected:', productId);
        
        // Wait for Flutter to render the page, then extract product info
        setTimeout(() => {
          tryExtractProductInfo();
        }, 2000); // Wait 2 seconds for page to load
      } else {
        // Not a product page, reset to default
        resetMetaTags();
      }
    }

    // Function to extract product information from the rendered page
    function tryExtractProductInfo() {
      try {
        // Look for product title and other info in the DOM
        const titleElements = document.querySelectorAll('*');
        let productTitle = '';
        let productPrice = '';
        let productDescription = '';
        let productImage = '';

        // Try to find product title (look for large text elements)
        for (let element of titleElements) {
          const text = element.textContent || '';
          // Look for price patterns (ends with د.ع)
          if (text.includes('د.ع') && !productPrice) {
            productPrice = text.trim();
          }
          // Look for title (longer text that's not a price)
          if (text.length > 10 && text.length < 100 && !text.includes('د.ع') && !productTitle) {
            productTitle = text.trim();
          }
        }

        // Try to find the first product image
        const images = document.querySelectorAll('img');
        for (let img of images) {
          if (img.src && img.src.includes('firebasestorage') && !productImage) {
            productImage = img.src;
            break;
          }
        }

        // If we found some product info, update meta tags
        if (productTitle || productPrice) {
          const productData = {
            title: productTitle || 'منتج للبيع',
            description: `${productTitle || 'منتج للبيع'} - ${productPrice || 'السعر متغير'} - معروض للبيع في بلدروز`,
            imageUrl: productImage || 'https://baladruz.com/assets/icon/baladruz.png',
            price: productPrice.replace('د.ع', '').trim()
          };

          console.log('Updating meta tags with:', productData);
          updateMetaTags(productData);
        }
      } catch (error) {
        console.error('Error extracting product info:', error);
      }
    }

    // Listen for hash changes
    window.addEventListener('hashchange', handleRouteChange);
    
    // Handle initial page load
    window.addEventListener('load', () => {
      handleRouteChange();
    });

    // Make functions globally available
    window.updateMetaTags = updateMetaTags;
    window.resetMetaTags = resetMetaTags;
    window.handleRouteChange = handleRouteChange;
  </script>
</head>
<body>
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>
